---
layout: post
title: STM32L1的独立看门狗（IWDG）和窗口看门狗（WWDG）
categories: MCU
description: STM32L1的独立看门狗（IWDG）和窗口看门狗（WWDG）
keywords: 独立看门狗, 窗口看门狗
---

> 原创
> 
> 转载请注明出处，侵权必究。

# 1.看门狗介绍
为了保证系统运行正常，防止出现跑飞的情况。

IWDG采用的是LSI时钟，即使主时钟发生故障，仍然有效。而LSI是一个内部的RC时钟，并不准确，在15kHz到47kHz之间变化，平均值为32kHz左右。


IWDG最适合于那些要求看门狗在主应用之外运行完全独立的过程，但是有较低的计时精度限制。WWDG最适合于需要看门狗在精确计时窗口内做出反应的应用程序。

# 2.IWDG
## 2.1 IWDG主要特性
* 不同步的downcounter
* 从RC振荡器中取得时钟源（可以在待机Standby或者停止Stop模式中运行）
* downcounter的数值达到0的时候，复位。

## 2.2 IWDG寄存器描述	
* IWDG_KR 关键字寄存器
IWDG_KR寄存器赋值0xCCCC，独立看门狗开始启动，从0xFFF开始自减。如果减到了0，则系统复位。

IWDG_KR寄存器赋值0xAAAA，则IWDG_RLR的数值重装载到downcounter中，避免系统复位。

* IWDG_PR 预分频寄存器

用于设置，看门狗时钟的预分频系数，最低4，最高256。并且只使用了最低3位，也就是说只有8种预分频情况。

000：4分频   ；   001：8分频    ；    

010：16分频  ；   011：32分频   ；

100：64分频  ；   101：128分频  ；

110：256分频 ；   111：256分频（没错，110和111相同）。

>注：IWDG_PR和IWDG_RLR寄存器具有写保护功能，要修改这两个寄存器的数值，要给IWDG_KR赋值0x5555。其他值写入IWDG_KR，会重新启动写保护。


* IWDG_RLR 重装载寄存器

只有低12位有效，也就是最大4095。

>IWDG_PR和IWDG_RLR寄存器具有写保护功能，要修改这两个寄存器的数值，要给IWDG_KR赋值0x5555。其他值写入IWDG_KR，会重新启动写保护。

* IWDG_SR 状态寄存器

PVU（bit 0）：独立看门狗分频系数更新。硬件set或者reset，1：正在更新；0：没有正在更新。

RVU（bit 1）：独立看门狗计数器重装载更新标志。硬件set或者reset，1：正在更新；0：没有正在更新。

## 2.3 IWDG配置步骤
1）独立看门狗初始化

需要自行定义

```
static void MX_IWDG_Init(void)
{

  hiwdg.Instance = IWDG;
  hiwdg.Init.Prescaler = IWDG_PRESCALER_32;
  hiwdg.Init.Reload = 4095;
  if (HAL_IWDG_Init(&hiwdg) != HAL_OK)
  {
    _Error_Handler(__FILE__, __LINE__);
  }

}
```	
溢出时间的计算：

Tout = 重装载数值/(LSI的频率/分频系数)

2）重载计数值喂狗

0xAAAA写入到IWDG_KR

```
HAL_StatusTypeDef HAL_IWDG_Refresh(IWDG_HandleTypeDef *hiwdg)
{
  /* Reload IWDG counter with value defined in the reload register */
  __HAL_IWDG_RELOAD_COUNTER(hiwdg);

  /* Return function status */
  return HAL_OK;
}
```

3）启动看门狗

HAL_IWDG_Init(&hiwdg)函数中包含了该函数。

```
__HAL_IWDG_START(hiwdg);
```